import json
import boto3

def lambda_handler(event, context):
    """Lambda function to extract username & changed resource details from CloudTrail logs."""
    
    # CloudTrail event records
    records = event.get('Records', [])
    
    for record in records:
        # Extract user identity
        user_identity = record.get('userIdentity', {})
        username = user_identity.get('userName', user_identity.get('principalId', 'Unknown User'))
        
        # Extract event details
        event_name = record.get('eventName', 'Unknown Event')
        event_source = record.get('eventSource', 'Unknown Source')
        
        # Extract changed resource details
        resource_list = record.get('resources', [])
        if resource_list:
            for resource in resource_list:
                resource_type = resource.get('resourceType', 'Unknown Resource Type')
                resource_name = resource.get('resourceName', 'Unknown Resource Name')
                print(f"👤 User: {username} | 🔄 Action: {event_name} | 🏷️ Resource: {resource_type} - {resource_name}")
        else:
            print(f"👤 User: {username} | 🔄 Action: {event_name} | Source: {event_source} (No direct resource found)")

    return {
        'statusCode': 200,
        'body': 'CloudTrail monitoring completed.'
    }
