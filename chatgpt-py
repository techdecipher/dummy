import boto3
import time

cloudformation = boto3.client('cloudformation')

def get_all_stacks():
    """Retrieve all CloudFormation stacks that are not in DELETE_COMPLETE state."""
    stacks = []
    paginator = cloudformation.get_paginator('list_stacks')
    for page in paginator.paginate(StackStatusFilter=[
        'CREATE_COMPLETE', 'UPDATE_COMPLETE', 'UPDATE_ROLLBACK_COMPLETE', 'ROLLBACK_COMPLETE'
    ]):
        stacks.extend(page['StackSummaries'])
    return [stack['StackName'] for stack in stacks]

def check_drift_status(stack_name):
    """Check existing drift status and wait if detection is in progress."""
    stack_info = cloudformation.describe_stacks(StackName=stack_name)['Stacks'][0]
    drift_info = stack_info.get('DriftInformation', {})
    drift_status = drift_info.get('StackDriftStatus', 'UNKNOWN')

    if drift_status == "DETECTION_IN_PROGRESS":
        print(f"Drift detection already in progress for {stack_name}. Waiting...")
        while True:
            time.sleep(10)  # Wait before checking again
            stack_info = cloudformation.describe_stacks(StackName=stack_name)['Stacks'][0]
            drift_status = stack_info.get('DriftInformation', {}).get('StackDriftStatus', 'UNKNOWN')
            if drift_status != "DETECTION_IN_PROGRESS":
                return drift_status

    return drift_status

def detect_stack_drift(stack_name):
    """Initiate drift detection only if not already in progress."""
    drift_status = check_drift_status(stack_name)

    if drift_status not in ["DRIFTED", "IN_SYNC"]:
        try:
            response = cloudformation.detect_stack_drift(StackName=stack_name)
            drift_detection_id = response['StackDriftDetectionId']

            # Wait for completion
            while True:
                time.sleep(10)
                stack_info = cloudformation.describe_stacks(StackName=stack_name)['Stacks'][0]
                drift_status = stack_info.get('DriftInformation', {}).get('StackDriftStatus', 'UNKNOWN')
                if drift_status != "DETECTION_IN_PROGRESS":
                    return drift_status
        except Exception as e:
            print(f"Error detecting drift for stack {stack_name}: {str(e)}")
            return "UNKNOWN"

    return drift_status

def lambda_handler(event, context):
    """Lambda function to detect drift for all CloudFormation stacks."""
    stack_names = get_all_stacks()

    for stack_name in stack_names:
        drift_status = detect_stack_drift(stack_name)
        print(f"CloudFormation Drift Status for {stack_name}: {drift_status}")

    return {
        'statusCode': 200,
        'body': 'Drift detection completed for all stacks.'
    }
